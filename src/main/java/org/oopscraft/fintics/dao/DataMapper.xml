<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.oopscraft.fintics.dao.DataMapper">

    <cache eviction="FIFO" flushInterval="60000" size="512"/>

    <select id="selectAssetOhlcvSummaries" resultType="org.oopscraft.fintics.model.AssetOhlcvSummary">
        SELECT      fta.asset_id AS "assetId",
                    fa.asset_name AS "assetName",
                    (SELECT COUNT(*) FROM fintics_trade_asset WHERE asset_id = fta.asset_id) AS "tradeCount",
                    fao.daily_count AS "dailyCount",
                    fao.daily_min_date_time AS "dailyMinDateTime",
                    fao.daily_max_date_time AS "dailyMaxDateTime",
                    fao.minute_count AS "minuteCount",
                    fao.minute_min_date_time AS "minuteMinDateTime",
                    fao.minute_max_date_time AS "minuteMaxDateTime"
        FROM 		(
                    SELECT 		DISTINCT
                                asset_id
                    FROM 		fintics_asset_ohlcv fao
                    UNION
                    SELECT		DISTINCT
                                asset_id
                    FROM 		fintics_trade_asset fta
                    ) fta
        LEFT OUTER JOIN
                    fintics_asset fa
        ON 			    fa.asset_id = fta.asset_id
        LEFT OUTER JOIN
                    (
                    SELECT 	    asset_id,
                                SUM(CASE WHEN type = 'DAILY' THEN 1 ELSE 0 END) AS daily_count,
                                MIN(CASE WHEN type = 'DAILY' THEN date_time ELSE NULL END) AS daily_min_date_time,
                                MAX(CASE WHEN type = 'DAILY' THEN date_time ELSE NULL END) AS daily_max_date_time,
                                SUM(CASE WHEN type = 'MINUTE' THEN 1 ELSE 0 END) AS minute_count,
                                MIN(CASE WHEN type = 'MINUTE' THEN date_time ELSE NULL END) AS minute_min_date_time,
                                MAX(CASE WHEN type = 'MINUTE' THEN date_time ELSE NULL END) AS minute_max_date_time
                    FROM 		fintics_asset_ohlcv
                    WHERE       1 = 1
                    <if test="assetId != null">
                    AND         asset_id = #{assetId}
                    </if>
                    GROUP BY 	asset_id
                    ) fao
        ON 			fao.asset_id = fta.asset_id
        WHERE       1 = 1
        <if test="assetId != null">
        AND         fta.asset_id = #{assetId}
        </if>
        ORDER BY 	fta.asset_id
    </select>

    <select id="selectIndiceOhlcvSummaries" resultType="org.oopscraft.fintics.model.IndiceOhlcvSummary">
        SELECT 	    indice_id AS "indiceId",
                    SUM(CASE WHEN type = 'DAILY' THEN 1 ELSE 0 END) AS "dailyCount",
                    MIN(CASE WHEN type = 'DAILY' THEN date_time ELSE NULL END) AS "dailyMinDateTime",
                    MAX(CASE WHEN type = 'DAILY' THEN date_time ELSE NULL END) AS "dailyMaxDateTime",
                    SUM(CASE WHEN type = 'MINUTE' THEN 1 ELSE 0 END) AS "minuteCount",
                    MIN(CASE WHEN type = 'MINUTE' THEN date_time ELSE NULL END) AS "minuteMinDateTime",
                    MAX(CASE WHEN type = 'MINUTE' THEN date_time ELSE NULL END) AS "minuteMaxDateTime"
        FROM 		fintics_indice_ohlcv
        WHERE       1 = 1
        <if test="indiceId != null">
        AND         indice_id = #{indiceId}
        </if>
        GROUP BY 	indice_id
    </select>

    <select id="selectAssetOhlcvStatistics" resultType="org.oopscraft.fintics.model.OhlcvSummary$OhlcvStatistic" useCache="false">
        SELECT 		DATE(date_time) AS "date",
                    COUNT(*) AS "count"
        FROM 		fintics_asset_ohlcv
        WHERE 		1 = 1
        AND 		asset_id = #{assetId}
        GROUP BY	DATE(date_time)
        ORDER BY    DATE(date_time) DESC
    </select>

    <select id="selectIndiceOhlcvStatistics" resultType="org.oopscraft.fintics.model.OhlcvSummary$OhlcvStatistic" useCache="false">
        SELECT 		DATE(date_time) AS "date",
                    COUNT(*) AS "count"
        FROM 		fintics_indice_ohlcv
        WHERE 		1 = 1
        AND 		indice_id = #{indiceId}
        GROUP BY	DATE(date_time)
        ORDER BY    DATE(date_time) DESC
    </select>


</mapper>