<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<th:block layout:fragment="_content">
    <script th:inline="javascript">
        Chart.defaults.font.size = 8;
        Chart.defaults.animation = false;

        const indices = /*[[${indices}]]*/[];
        const trades = /*[[${trades}]]*/[];

        let indiceDailyOhlcvsChart = null;
        let indiceMinuteOhlcvsChart = null;

        const tradeAssetDailyOhlcvsChartMap = new Map();
        const tradeAssetMinuteOhlcvsChartMap = new Map();
        const tradeOrdersMap = new Map();
        trades.forEach(trade => {
            tradeOrdersMap.set(trade.tradeId, new duice.ArrayProxy([]));
        });
        const tradeLogEventSourceMap = new Map();

        function initializeIndiceMonitor() {
            indiceDailyOhlcvsChart = createDailyOhlcvsChart('indiceDailyOhlcvsChart');
            indiceMinuteOhlcvsChart = createMinuteOhlcvsChart('indiceMinuteOhlcvsChart');
        }

        function getIndiceMonitor() {
            const promises = indices.map(indice => {
                let url = new URL(`${_apiUrl}/v1/indice/${indice.symbol}/indicator`, document.location.origin);
                return _fetch(url);
            });
            Promise.all(promises)
                .then(responses => {
                    return Promise.all(responses.map(
                        response => response.json()));
                }).then(indiceIndicators => {
                    let now = new Date();

                    // define date from
                    let dailyFrom = dateFns.subMonths(now, 3);
                    let dailyTo = new Date(now.getTime());
                    let minuteFrom = dateFns.subDays(now, 1);
                    let minuteTo = new Date(now.getTime());

                    // indice chart
                    indiceDailyOhlcvsChart.data.datasets.length = 0;
                    indiceMinuteOhlcvsChart.data.datasets.length = 0;
                    for(let i = 0; i < indiceIndicators.length; i ++) {
                        let indiceIndicator = indiceIndicators[i];

                        // daily
                        let dailyOhlcvs = indiceIndicator['dailyOhlcvs'];
                        let dailyTimeSeries = createTimeSeries(dailyFrom, dailyTo, dailyOhlcvs, 60000*60*24);
                        let dailyDataset = {
                            label: indiceIndicator.name,
                            data: dailyTimeSeries,
                            borderWidth: 1,
                            pointStyle: false
                        };
                        indiceDailyOhlcvsChart.data.datasets.push(dailyDataset);

                        // minute
                        let minuteOhlcvs = indiceIndicator['minuteOhlcvs'];
                        let minuteTimeSeries = createTimeSeries(minuteFrom, minuteTo, minuteOhlcvs, 60000);
                        let minuteDataset = {
                            label: indiceIndicator.name,
                            data: minuteTimeSeries,
                            borderWidth: 1,
                            pointStyle: false
                        };
                        indiceMinuteOhlcvsChart.data.datasets.push(minuteDataset);
                    }
                    indiceDailyOhlcvsChart.update();
                    indiceMinuteOhlcvsChart.update();
                });
        }

        function initializeTradeMonitors() {
            trades.forEach(trade => {
                initializeTradeMonitor(trade.tradeId);
            });
        }

        function initializeTradeMonitor(tradeId) {
            // chart
            let dailyOhlcvsChart = createDailyOhlcvsChart(`tradeAssetDailyOhlcvsChart-${tradeId}`);
            tradeAssetDailyOhlcvsChartMap.set(tradeId, dailyOhlcvsChart);
            let minuteOhlcvsChart = createMinuteOhlcvsChart(`tradeAssetMinuteOhlcvsChart-${tradeId}`);
            tradeAssetMinuteOhlcvsChartMap.set(tradeId, minuteOhlcvsChart);

            // log event source
            startTradeLogEventSource(tradeId);
        }

        function startTradeLogEventSource(tradeId) {
            let tradeLog = document.getElementById(`tradeLog-${tradeId}`);
            let tradeLogEventSource = new EventSource(`${_apiUrl}/v1/trade/${tradeId}/log`);
            tradeLogEventSourceMap.set(tradeId, tradeLogEventSource);

            tradeLogEventSource.onopen = () => {
                let message = 'SSE Connected.';
                console.log(message);
                tradeLog.value += message + '\n';
                tradeLog.scrollTop = tradeLog.scrollHeight;
            }
            tradeLogEventSource.onmessage = (event) => {
                let message = event.data;
                console.log(message);
                tradeLog.value += message + '\n';
                tradeLog.scrollTop = tradeLog.scrollHeight;
            };
            tradeLogEventSource.onerror = (event) => {
                if (event.eventPhase === EventSource.CLOSED) {
                    let message = 'SSE connection closed. Reconnecting...';
                    console.log(message);
                    tradeLog.value += message + '\n';
                    tradeLog.scrollTop = tradeLog.scrollHeight;
                    tradeLogEventSource.close();
                    setTimeout(function() {
                        startTradeLogEventSource(tradeId);
                    }, 3000);
                }
            };
        }

        function getTradeMonitors() {
            trades.forEach(trade => {
                getTradeMonitor(trade.tradeId);
            });
        }

        function getTradeMonitor(tradeId) {
            let indicatorUrl = new URL(`${_apiUrl}/v1/trade/${tradeId}/indicator`, document.location.origin);
            _fetch(indicatorUrl)
                .then(response => response.json())
                .then(assetIndicators => {

                    // calculate max date time
                    let maxDateTime = dateFns.subMonths(new Date(), 30);
                    assetIndicators.forEach(assetIndicator => {
                        let minuteOhlcvs = assetIndicator['minuteOhlcvs'];
                        if(minuteOhlcvs.length > 0) {
                            let dateTime = new Date(minuteOhlcvs[0].dateTime);
                            if(dateTime.getTime() > maxDateTime.getTime()) {
                                maxDateTime = new Date(dateTime.getTime());
                            }
                        }
                    });

                    // define date from
                    let dailyFrom = dateFns.subMonths(maxDateTime, 3);
                    let dailyTo = new Date(maxDateTime.getTime());

                    let minuteFrom = dateFns.subDays(maxDateTime, 1);
                    let minuteTo = new Date(maxDateTime.getTime());

                    // asset chart
                    let dailyOhlcvsChart = tradeAssetDailyOhlcvsChartMap.get(tradeId);
                    let minuteOhlcvsChart = tradeAssetMinuteOhlcvsChartMap.get(tradeId);
                    dailyOhlcvsChart.data.datasets.length = 0;
                    minuteOhlcvsChart.data.datasets.length = 0;
                    assetIndicators.forEach(assetIndicator => {
                        // daily
                        let dailyOhlcvs = assetIndicator['dailyOhlcvs'];
                        let dailyTimeSeries = createTimeSeries(dailyFrom, dailyTo, dailyOhlcvs, 60000*60*24);
                        let dailyDataset = {
                            label: assetIndicator.name,
                            data: dailyTimeSeries,
                            borderWidth: 1,
                            pointStyle: false
                        };
                        dailyOhlcvsChart.data.datasets.push(dailyDataset);

                        // minute
                        let minuteOhlcvs = assetIndicator['minuteOhlcvs'];
                        let minuteTimeSeries = createTimeSeries(minuteFrom, minuteTo, minuteOhlcvs, 60000);
                        let minuteDataset = {
                            label: assetIndicator.name,
                            data: minuteTimeSeries,
                            borderWidth: 1,
                            pointStyle: false
                        };
                        minuteOhlcvsChart.data.datasets.push(minuteDataset);
                    });
                    dailyOhlcvsChart.update();
                    minuteOhlcvsChart.update();
                });

            let orderUrl = new URL(`${_apiUrl}/v1/trade/${tradeId}/order`, document.location.origin);
            _fetch(orderUrl)
                .then(response => response.json())
                .then(orders => {
                    duice.ArrayProxy.assign(tradeOrdersMap.get(tradeId), orders);
                });
        }

        function createDailyOhlcvsChart(elementId) {
            return new Chart(document.getElementById(elementId), {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    maintainAspectRatio: false,
                    parsing: {
                        xAxisKey: 'dateTime',
                        yAxisKey: 'pctChange'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            distribution: 'linear',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    hour: 'MM-dd'
                                }
                            },
                            ticks: {
                                stepSize: 7,
                                font: {
                                    size: 8
                                }
                            },
                            title: {
                                display: true,
                                text: 'Daily',
                                color: '#911',
                                font: {
                                    weight: 'bold',
                                    lineHeight: 1.2,
                                },
                                padding: {top: 5, left: 0, right: 0, bottom: 0}
                            }
                        },
                        y: {
                            ticks: {
                                stepSize: 0.5,
                                font: {
                                    size: 8
                                },
                                callback: function(value, index, values) {
                                    return value.toFixed(2) + ' %';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw['closePrice'].toLocaleString() +
                                        ' (' + context.raw['pctChange'] + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMinuteOhlcvsChart(elementId) {
            return new Chart(document.getElementById(elementId), {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    maintainAspectRatio: false,
                    parsing: {
                        xAxisKey: 'dateTime',
                        yAxisKey: 'pctChange'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            distribution: 'linear',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MM-dd HH:00'
                                }
                            },
                            ticks: {
                                stepSize: 2,
                                font: {
                                    size: 8
                                }
                            },
                            title: {
                                display: true,
                                text: 'Minute',
                                color: '#911',
                                font: {
                                    weight: 'bold',
                                    lineHeight: 1.2,
                                },
                                padding: {top: 5, left: 0, right: 0, bottom: 0}
                            }
                        },
                        y: {
                            ticks: {
                                stepSize: 0.5,
                                font: {
                                    size: 8
                                },
                                callback: function(value, index, values) {
                                    return value.toFixed(2) + ' %';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw['closePrice'].toLocaleString() +
                                        ' (' + context.raw['pctChange'] + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTimeSeries(dateFrom, dateTo, ohlcvs, interval) {
            let timeSeries = [];
            let dateFromMillis = dateFrom.getTime();
            let dateToMillis = dateTo.getTime();
            for(let millis = dateFromMillis; millis <= dateToMillis; millis += interval) {
                timeSeries.push({
                    dateTime: new Date(millis),
                    pctChange: 0.0,
                    openPrice: 0,
                    highPrice: 0,
                    lowPrice: 0,
                    closePrice: 0
                });
            }

            let ohlcvSeries = JSON.parse(JSON.stringify(ohlcvs)).reverse();
            ohlcvSeries.forEach((ohlcv) => ohlcv.dateTime = new Date(ohlcv.dateTime));
            let ohlcvPos = Math.max(0, ohlcvSeries.findIndex((ohlcv) => {
                return ohlcv.dateTime.getTime() >= timeSeries[0].dateTime.getTime();
            }));
            let ohlcvBasePrice = ohlcvSeries.length > 0 ? ohlcvSeries[ohlcvPos].openPrice : 0.0;
            let prevOhlcvPoint;
            for(let i = 0, length = timeSeries.length; i < length; i ++) {
                let timePoint = timeSeries[i];
                let timeRangeFromMillis = timePoint.dateTime.getTime();
                let timeRangeToMillis = timeRangeFromMillis + (interval - 1);
                if(ohlcvPos < ohlcvSeries.length) {
                    let ohlcvPoint = ohlcvSeries[ohlcvPos];
                    let ohlcvDateTimeMillis = ohlcvPoint.dateTime.getTime();
                    if(timeRangeFromMillis <= ohlcvDateTimeMillis && ohlcvDateTimeMillis < timeRangeToMillis) {
                        ohlcvPoint.pctChange = Number((ohlcvPoint.closePrice - ohlcvBasePrice)/ohlcvBasePrice * 100).toFixed(4);
                        timeSeries[i].pctChange = ohlcvPoint.pctChange;
                        timeSeries[i].openPrice = ohlcvPoint.openPrice;
                        timeSeries[i].highPrice = ohlcvPoint.highPrice;
                        timeSeries[i].lowPrice = ohlcvPoint.lowPrice;
                        timeSeries[i].closePrice = ohlcvPoint.closePrice;
                        timeSeries[i].volume = ohlcvPoint.volume;
                        prevOhlcvPoint = ohlcvPoint;
                        ohlcvPos ++;
                        continue;
                    }
                }
                if(prevOhlcvPoint) {
                    timeSeries[i].pctChange = prevOhlcvPoint.pctChange;
                    timeSeries[i].openPrice = prevOhlcvPoint.openPrice;
                    timeSeries[i].highPrice = prevOhlcvPoint.highPrice;
                    timeSeries[i].lowPrice = prevOhlcvPoint.lowPrice;
                    timeSeries[i].closePrice = prevOhlcvPoint.closePrice;
                    timeSeries[i].volume = prevOhlcvPoint.volume;
                }
            }
            return timeSeries;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeIndiceMonitor();
            initializeTradeMonitors();

            // refresh
            getIndiceMonitor();
            getTradeMonitors();
            setInterval(function() {
                getIndiceMonitor();
                getTradeMonitors();
            }, 1000*60);
        });

        window.addEventListener('beforeunload', () => {
            tradeLogEventSourceMap.forEach((eventSource) => {
                try {
                    eventSource.close();
                }catch(e){}
            });
        });
    </script>
    <style th:inline="css">
        .tradeLog {
            padding-top: 0.5em;
            line-height: 1.2em;
            background-color: black;
            color: white;
            font-family: monospace;
            font-size: smaller;
        }
    </style>

    <!-- ====================================== -->
    <!-- start: title                           -->
    <!-- ====================================== -->
    <h1 id="title">
        <img class="icon" th:src="@{/static/image/icon-monitor.svg}" alt="monitor"/>
        <span data-th-text="#{web.global.monitor}"></span>
    </h1>
    <!-- ====================================== -->
    <!-- end: title                             -->
    <!-- ====================================== -->

    <div class="flex flex-direction-column gap-1em">
        <!-- ================================== -->
        <!-- start: indice                      -->
        <!-- ================================== -->
        <div class="border-1 padding-1em">
            <h2>
                <img class="icon" th:src="@{/static/image/icon-indice.svg}" alt="indice"/>
                Indice Indicator
            </h2>
            <div class="grid grid-template-columns-12">
                <div class="grid-column-4 s-grid-column-12" style="height:150px;">
                    <canvas id="indiceDailyOhlcvsChart"></canvas>
                </div>
                <div class="grid-column-8 s-grid-column-12" style="height:150px;">
                    <canvas id="indiceMinuteOhlcvsChart"></canvas>
                </div>
            </div>
        </div>
        <!-- ================================== -->
        <!-- end: indice                        -->
        <!-- ================================== -->

        <!-- ================================== -->
        <!-- start: trade                       -->
        <!-- ================================== -->
        <div class="grid grid-template-columns-12 grid-gap-1px">
            <div th:each="trade : ${trades}" class="grid-column-12 border-1 padding-1em">
                <h2>
                    <img class="icon" th:src="@{/static/image/icon-trade.svg}" alt="indice"/>
                    <span data-th-text="${trade.name}"></span>
                </h2>
                <div class="grid grid-template-columns-12 grid-gap-1em">
                    <div class="grid-column-4 s-grid-column-12" style="height:150px;">
                        <canvas th:id="'tradeAssetDailyOhlcvsChart-' + ${trade.tradeId}"></canvas>
                    </div>
                    <div class="grid-column-8 s-grid-column-12" style="height:150px;">
                        <canvas th:id="'tradeAssetMinuteOhlcvsChart-' + ${trade.tradeId}"></canvas>
                    </div>
                    <div class="grid-column-4 s-grid-column-12">
                        <div class="overflow-y-scroll overflow-x-scroll border-1" style="height:100px;">
                            <table class="width-100 font-size-smaller border-0" style="line-height:normal;">
                                <colgroup>
                                    <col style="width:5rem;"/>
                                    <col style="width:3em;"/>
                                    <col/>
                                    <col/>
                                    <col style="width:5rem;"/>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th data-th-text="#{fintics.Order.orderAt}"></th>
                                    <th data-th-text="#{fintics.Order.orderType}"></th>
                                    <th data-th-text="#{fintics.Order.name}"></th>
                                    <th data-th-text="#{fintics.Order.quantity}"></th>
                                    <th data-th-text="#{fintics.Order.orderResult}"></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:data-duice-bind="'tradeOrdersMap.get(\'' + ${trade.tradeId} + '\')'" data-duice-loop="order,status">
                                    <td data-duice-bind="order" data-duice-property="orderAt" data-duice-format="date('yyyy-MM-dd HH:mm:ss')"></td>
                                    <td data-duice-bind="order" data-duice-property="orderType"></td>
                                    <td data-duice-bind="order" data-duice-property="name"></td>
                                    <td data-duice-bind="order" data-duice-property="quantity"></td>
                                    <td data-duice-bind="order" data-duice-property="orderResult"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="grid-column-8 s-grid-column-12">
                        <textarea th:id="'tradeLog-' + ${trade.tradeId}" class="tradeLog width-100" style="height:100px;"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <!-- ================================== -->
        <!-- end: trade                         -->
        <!-- ================================== -->

    </div>




</th:block>
