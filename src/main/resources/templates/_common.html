<!-- ====================================== -->
<!-- start: _assetDialog                    -->
<!-- ====================================== -->
<th:block th:fragment="_assetDialog">
    <dialog id="_assetDialog">
        <style th:inline="css">
            #_assetDialog {
            }
            #_assetDialogChart {
                width: 1000px;
                height: 300px;
            }
        </style>
        <script th:inline="javascript">
            const _assetDialog = {
                dialog: new duice.dialog.Dialog(document.getElementById('_assetDialog')),
                assetId: null,
                asset: new duice.ObjectProxy({}),
                minuteOhlcvs: [],
                dailyOhlcvs: [],
                chart: null,
                candlestickSeries: null,
                open: async function(assetId) {
                    this.assetId = assetId;

                    // opens dialog
                    let promise = this.dialog.open();

                    // creates chart
                    if (!this.chart) {
                        const chartOptions = {
                            layout: {
                                textColor: 'black',
                                background: {
                                    type: 'solid',
                                    color: 'white'
                                },
                                fontFamily: 'Nanum Gothic Coding',
                                attributionLogo: false
                            },
                            timeScale: {
                                timeVisible: true,
                            },
                            priceScale: {
                                autoScale: true,
                            },
                        };
                        this.chart = LightweightCharts.createChart(document.getElementById('_assetDialogChart'), chartOptions);
                        this.candlestickSeries = this.chart.addCandlestickSeries({
                            upColor: '#26a69a',
                            downColor: '#ef5350',
                            borderVisible: false,
                            wickUpColor: '#26a69a',
                            wickDownColor: '#ef5350'
                        });
                    }

                    // clears data
                    duice.ObjectProxy.clear(this.asset);
                    this.minuteOhlcvs = [];
                    this.dailyOhlcvs = [];
                    this.candlestickSeries.setData([]);
                    document.getElementsByName('_assetDialogChartPeriod').forEach(it => it.checked = false);

                    // retrieves asset
                    this.getAsset();

                    // retrieves ohlcvs
                    Promise.all([
                        this.getOhlcvs('minute'),
                        this.getOhlcvs('daily')
                    ])
                    .then(([minuteOhlcvs, dailyOhlcvs]) => {
                        this.minuteOhlcvs = minuteOhlcvs;
                        this.dailyOhlcvs = dailyOhlcvs;

                        // draw default chart
                        document.getElementsByName('_assetDialogChartPeriod')[0].checked = true;
                        this.drawChart('minute', 1);
                    });

                    // returns promise
                    return promise;
                },
                getAsset: function() {
                    let url = new URL(`${_apiUrl}/v1/assets/${this.assetId}`, document.location.href);
                    _fetch(url).then(response => response.json())
                    .then(responseBody => {
                        duice.ObjectProxy.clear(this.asset);
                        duice.ObjectProxy.assign(this.asset, responseBody);
                    });
                },
                getOhlcvs: function(type) {
                    let url = new URL(`${_apiUrl}/v1/ohlcvs/${this.assetId}/${type}`, document.location.href);
                    url.searchParams.append('_size', 10000);
                    return _fetch(url).then(response => response.json());
                },
                drawChart: function(type, period) {
                    let ohlcvs;
                    if (type === 'minute') {
                        ohlcvs = this.minuteOhlcvs;
                    }
                    if (type === 'daily') {
                        ohlcvs = this.dailyOhlcvs;
                    }
                    let ohlcvSeries = ohlcvs.map(it => {
                        return {
                            time: Math.floor(new Date(it.dateTime).getTime()/1000),
                            open: it.open,
                            high: it.high,
                            low: it.low,
                            close: it.close,
                            volume: it.volume
                        };
                    }).reverse();

                    // resample
                    if (period> 1) {
                        ohlcvSeries = this.resample(ohlcvSeries, period);
                    }

                    // chart options
                    const chartOptions = {
                        layout: {
                            textColor: 'black',
                            background: {
                                type: 'solid',
                                color: 'white'
                            }
                        },
                        timeScale: {
                            timeVisible: false,
                        }
                    };
                    if (type === 'minute') {
                        chartOptions.timeScale.timeVisible = true;
                    }
                    this.chart.applyOptions(chartOptions);

                    // set chart data
                    this.candlestickSeries.setData([]);
                    this.candlestickSeries.setData(ohlcvSeries);
                    this.chart.timeScale().fitContent();
                },
                resample(ohlcvSeries, period) {
                    const resampledData = [];
                    let currentCandle = null;

                    ohlcvSeries.forEach(item => {
                        const date = new Date(item.time * 1000);
                        const minutes = date.getMinutes();

                        // interval 분 단위로 새로운 캔들 시작
                        if (minutes % period === 0 || !currentCandle) {
                            if (currentCandle) {
                                resampledData.push(currentCandle);
                            }
                            currentCandle = {
                                time: item.time,
                                open: item.open,
                                high: item.high,
                                low: item.low,
                                close: item.close,
                                volume: item.volume
                            };
                        } else {
                            // 현재 캔들을 업데이트
                            currentCandle.high = Math.max(currentCandle.high, item.high);
                            currentCandle.low = Math.min(currentCandle.low, item.low);
                            currentCandle.close = item.close;
                            currentCandle.volume += item.volume;
                        }
                    });

                    // 마지막 캔들을 추가
                    if (currentCandle) {
                        resampledData.push(currentCandle);
                    }

                    // returns
                    return resampledData;
                }
            }
        </script>
        <div class="display--flex flex-direction--column padding--1em">
            <div>
                <h1>
                    <img class="icon" th:src="@{/static/image/icon-asset.svg}" alt="asset"/>
                    <span data-th-text="#{fintics.Asset}"></span>
                </h1>
            </div>
            <div class="display--flex flex-direction--column gap--1em padding--1em">
                <div>
                    <img class="icon" th:src="@{/static/image/icon-detail.svg}" alt="detail"/>
                    <span data-th-text="|#{fintics.Asset} #{web.global.detail}|" class="font-weight--bold"></span>
                </div>
                <div class="display--grid grid-template-columns--12 gap--1em border--1 padding--1em">
                    <div class="grid-column--6">
                        <table class="width--100 border--0">
                            <tbody>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.symbol}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <span data-duice-bind="_assetDialog.asset" data-duice-property="symbol" class="code font-weight--bold"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.name}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <img class="icon icon--circle font-size--large vertical-align--middle" data-duice-bind="_assetDialog.asset" data-duice-property="icon" th:onerror="|this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                                    &nbsp;
                                    <span class="vertical-align--middle" data-duice-bind="_assetDialog.asset" data-duice-property="name"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.market}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <span data-duice-bind="_assetDialog.asset" data-duice-property="market" class="code badge"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.exchange}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <span data-duice-bind="_assetDialog.asset" data-duice-property="exchange" class="code badge"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.type}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <span data-duice-bind="_assetDialog.asset" data-duice-property="type" class="code badge"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span data-th-text="#{fintics.Asset.updatedDate}" class="font-weight--bold"></span>
                                </td>
                                <td>
                                    <span data-duice-bind="_assetDialog.asset" data-duice-property="updatedDate" class="date"></span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="grid-column--6 overflow-y--scroll">
                        <div class="overflow-y--scroll padding--1em border-y--1" style="height:200px;">
                            <table class="width--100 border--0 font-size--smaller code">
                                <colgroup>
                                    <col class="width--50"/>
                                    <col class="width--50"/>
                                </colgroup>
                                <tbody>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.marketCap}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="marketCap" data-duice-format="number" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.eps}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="eps" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.roe}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="roe" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.roa}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="roa" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.per}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="per" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.dividendYield}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="dividendYield" class="text-align--right"></td>
                                </tr>
                                <tr>
                                    <td data-th-text="#{fintics.Asset.dividendFrequency}"></td>
                                    <td data-duice-bind="_assetDialog.asset" data-duice-property="dividendFrequency" class="text-align--right"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="display--flex justify-content--space-between align-items--center">
                    <div>
                        <img class="icon" th:src="@{/static/image/icon-ohlcv.svg}" alt="ohlcv"/>
                        <span data-th-text="#{fintics.Ohlcv}" class="font-weight--bold"></span>
                    </div>
                    <div class="text-align--right code font-size--smaller">
                        <div class="display--flex gap--1em code">
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 1);"/>
                                1m
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 3);"/>
                                3m
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 5);"/>
                                5m
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 10);"/>
                                10m
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 30);"/>
                                30m
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('minute', 60);"/>
                                1H
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('daily', 1);"/>
                                1D
                            </label>
                            <label>
                                <input name="_assetDialogChartPeriod" type="radio" onclick="_assetDialog.drawChart('daily', 5);"/>
                                1W
                            </label>
                        </div>
                    </div>
                </div>
                <div id="_assetDialogChart" class="width--100"></div>
           </div>
        </div>
    </dialog>
</th:block>
<!-- ====================================== -->
<!-- end: _assetDialog                      -->
<!-- ====================================== -->
