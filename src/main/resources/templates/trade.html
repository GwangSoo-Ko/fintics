<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<th:block layout:fragment="_content">
    <script th:src="@{/static/fintics.js?version={version}(version=${_scriptVersion})}"></script>
    <script th:inline="javascript">
        const tradeId = /*[[${tradeId}]]*/'';
        const alarms = new duice.ArrayProxy(/*[[${alarms}]]*/[]);
        const brokers = new duice.ArrayProxy(/*[[${brokers}]]*/[]);
        const brokerClientDefinitions = new duice.ArrayProxy(/*[[${brokerClientDefinitions}]]*/[]);
        const baskets = new duice.ArrayProxy(/*[[${baskets}]]*/[]);
        const strategies = new duice.ArrayProxy(/*[[${strategies}]]*/[]);
        const cashAsset = new duice.ObjectProxy({});

        // basket
        const basket = new duice.ObjectProxy({
            basketAssets: []
        });
        duice.ArrayProxy.setReadonlyAll(basket.basketAssets, true);

        // strategy
        const strategy = new duice.ObjectProxy({});
        duice.ObjectProxy.setReadonlyAll(strategy, true);

        // trade
        const trade = new duice.ObjectProxy({
            tradeId: null,
            name: null,
            interval: null,
            threshold: null,
            cashAssetId: null,
            brokerId: null,
            tradeAssets: []
        });
        duice.ObjectProxy.onPropertyChanged(trade, async event => {
            if (event.getProperty() === 'strategyId') {
                let strategyId = event.getValue();
                if (strategyId) {
                    await getStrategy(strategyId);
                    if(!trade.strategyVariables) {
                        trade.strategyVariables = strategy.variables;
                    }
                } else {
                    duice.ObjectProxy.clear(strategy);
                }
            }
            if (event.getProperty() === 'basketId') {
                let basketId = event.getValue();
                if (basketId) {
                    await getBasket(basketId);
                } else {
                    duice.ObjectProxy.clear(basket);
                }
            }
        });

        // order
        const orderSearch = new duice.ObjectProxy({
            assetId: null,
            type: null,
            result: null,
            _page: 0,
            _size: 20,
            _count: 0
        });
        const orders = new duice.ArrayProxy([]);

        // balance
        const balance = new duice.ObjectProxy({
            total: null,
            cash: null,
            balanceAssets: []
        });
        duice.ObjectProxy.setReadonlyAll(balance, true);

        // checks authority
        let hasTradeEditAuthority = /*[[${#authorization.expression('hasAuthority(''trade.edit'')')}]]*/false;
        if (!hasTradeEditAuthority) {
            duice.ObjectProxy.setReadonlyAll(trade, true);
        }

        /**
         * get trades
         * @returns {Promise<void>}
         */
        async function getTrade() {
            let url = new URL(`${_apiUrl}/v1/trades/${tradeId}`, document.location.origin);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.assign(trade, data);
                    let cashAssetId = data['cashAssetId'];
                    if (cashAssetId) {
                        getCashAsset(cashAssetId);
                    }
                    let basketId = data['basketId'];
                    if (basketId) {
                        getBasket(basketId);
                    }
                    let strategyId = data['strategyId'];
                    if (strategyId) {
                        getStrategy(strategyId);
                    }
                });
        }

        /**
         * gets specified basket
         * @param basketId basket id
         * @returns {Promise<void>}
         */
        async function getBasket(basketId) {
            let url = new URL(`${_apiUrl}/v1/baskets/${basketId}`, document.location.origin);
            await _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.assign(basket, data);
                });
        }

        /**
         * gets strategy
         * @param strategyId strategy id
         * @returns {Promise<void>}
         */
        async function getStrategy(strategyId) {
            let url = new URL(`${_apiUrl}/v1/strategies/${strategyId}`, document.location.origin);
            await _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.assign(strategy, data);
                });
        }

        async function selectCashAsset() {
            let cashAsset = await cashAssetDialog.open();
            trade.cashAssetId = cashAsset.assetId;
            await getCashAsset(trade.cashAssetId);
        }

        async function getCashAsset(cashAssetId) {
            let url = new URL(`${_apiUrl}/v1/assets/${cashAssetId}`, document.location.origin);
            await _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.assign(cashAsset, data);
                });
        }

        function clearCashAsset() {
            trade.cashAssetId = null;
            duice.ObjectProxy.clear(cashAsset);
        }

        /**
         * saves trade
         * @returns {Promise<boolean>}
         */
        async function saveTrade() {
            if(!trade.name) {
                await _alert(/*[[#{web.global.itemEmpty(#{fintics.Trade.name})}]]*/'');
                duice.ObjectProxy.focus(trade, 'name');
                return false;
            }
            if(!trade.interval) {
                await _alert(/*[[#{web.global.itemEmpty(#{fintics.Trade.interval})}]]*/'');
                duice.ObjectProxy.focus(trade, 'interval');
                return false;
            }
            if(!trade.threshold) {
                await _alert(/*[[#{web.global.itemEmpty(#{fintics.Trade.threshold})}]]*/'');
                duice.ObjectProxy.focus(trade, 'threshold');
                return false;
            }

            _confirm(/*[[#{web.global.saveItemConfirm(#{fintics.Trade})}]]*/'')
                .then(result => {
                    if (result) {
                        let url;
                        let method;
                        if(!tradeId) {
                            url = `${_apiUrl}/v1/trades`;
                            method = 'POST';
                        }else{
                            url = `${_apiUrl}/v1/trades/${trade.tradeId}`;
                            method = 'PUT';
                        }
                        _fetch(new URL(url, document.location.origin), {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(trade)
                        }).then(response => response.json())
                            .then(data => {
                                _alert(/*[[#{web.global.saveItemComplete(#{fintics.Trade})}]]*/'')
                                    .then(() => {
                                        if(trade.tradeId) {
                                            duice.ObjectProxy.clear(trade);
                                            duice.ObjectProxy.assign(trade, data);
                                        }else{
                                            document.location.href = `${_rootUrl}/trade?tradeId=${data.tradeId}`;
                                        }
                                    });
                        });
                    }
                });
        }

        /**
         * deletes trade
         */
        function deleteTrade() {
            _confirm(/*[[#{web.global.deleteItemConfirm(#{fintics.Trade})}]]*/'')
                .then(result => {
                    if (result) {
                        let url = new URL(`${_apiUrl}/v1/trades/${tradeId}`, document.location.origin);
                        _fetch(url,{
                            method: 'DELETE'
                        }).then(response => {
                            if (response.ok) {
                                _alert(/*[[#{web.global.deleteItemComplete(#{fintics.Trade})}]]*/'')
                                    .then(() => {
                                        document.location.href = `${_rootUrl}/trades`;
                                    });
                            }
                        })
                    }
                });
        }

        /**
         * gets trade balance
         */
        function getTradeBalance() {
            let url = new URL(`${_apiUrl}/v1/trades/${tradeId}/balance`, document.location.origin);
            _fetch(url).then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.assign(balance, data);
                });
        }

        /**
         * sells balance asset
         * @param assetId asset id
         */
        function sellBalanceAsset(assetId) {
            let balanceAsset = balance.balanceAssets.find(it => it.assetId === assetId);
            submitOrderDialog.open(trade, balanceAsset, 'SELL');
        }

        /**
         * export trade
         */
        function exportTrade() {
            let tradeForExport = JSON.parse(JSON.stringify(trade, null, 4));
            delete tradeForExport.tradeId;
            tradeForExport.name += '_Copy';    // adds copy suffix in name
            let tradeForExportJson = JSON.stringify(tradeForExport, null, 4);
            let a = document.createElement('a');
            let href = 'data:application/json;charset=utf-8,' + encodeURIComponent(tradeForExportJson);
            let download = `trade_${trade.name}.json`;
            a.setAttribute('href', href);
            a.setAttribute('download', download);
            a.click();
        }

        /**
         * import trade
         */
        function importTrade() {
            let input = document.createElement('input');
            input.setAttribute("type", "file");
            input.setAttribute("accept", "application/json");
            input.addEventListener('change', function (e) {
                let fileReader = new FileReader();
                if (this.files && this.files[0]) {
                    fileReader.addEventListener("load", async function (event) {
                        let tradeForImport = JSON.parse(event.target.result);
                        // removes name if name is already exist.
                        if (trade.name) {
                            delete tradeForImport.name;
                        }
                        delete tradeForImport.tradeId;
                        duice.ObjectProxy.assign(trade, tradeForImport);

                        // load relatives data
                        let cashAssetId = tradeForImport['cashAssetId'];
                        if (cashAssetId) {
                            getCashAsset(cashAssetId);
                        }
                        let basketId = tradeForImport['basketId'];
                        if (basketId) {
                            getBasket(basketId);
                        }
                        let strategyId = tradeForImport['strategyId'];
                        if (strategyId) {
                            getStrategy(strategyId);
                        }
                    });
                    fileReader.readAsText(this.files[0]);
                }
                e.preventDefault();
                e.stopPropagation();
            });
            input.click();
        }

        document.addEventListener('DOMContentLoaded', () => {
            let tabFolder = duice.tabFolder(
                duice.tabItem(
                    document.getElementById('tradeTabButton'),
                    document.getElementById('tradeTabContent'),
                    () => {}),
                duice.tabItem(
                    document.getElementById('tradeBalanceTabButton'),
                    document.getElementById('tradeBalanceTabContent'),
                    () => {
                        getTradeBalance();
                    })
            );
            tabFolder.setActive(0);
            if(tradeId) {
                getTrade();
            }
        });

        window.addEventListener('beforeunload', () => {
            // void
        });
    </script>
    <style th:inline="css">
    </style>

    <!-- ====================================== -->
    <!-- start: title                           -->
    <!-- ====================================== -->
    <h1 id="title">
        <img class="icon" th:src="@{/static/image/icon-trade.svg}" alt="variable"/>
        <span data-th-text="#{fintics.Trade}"></span>
        <small>|</small>
        <span data-duice-bind="trade" data-duice-property="name"></span>
    </h1>
    <!-- ====================================== -->
    <!-- end: title                             -->
    <!-- ====================================== -->

    <!-- ====================================== -->
    <!-- start: tab index                       -->
    <!-- ====================================== -->
    <div id="tabIndex" class="display--flex flex-wrap--nowrap overflow-x--scroll gap--1px margin-bottom--1px">
        <button id="tradeTabButton" type="button" class="tab">
            <img class="icon" th:src="@{/static/image/icon-detail.svg}" alt="trade"/>
            <span data-th-text="#{fintics.Trade}"></span>
        </button>
        <button id="tradeBalanceTabButton" type="button" class="tab">
            <img class="icon" th:src="@{/static/image/icon-balance.svg}" alt="balance"/>
            <span data-th-text="#{fintics.Balance}"></span>
        </button>
    </div>
    <!-- ====================================== -->
    <!-- end: tab index                         -->
    <!-- ====================================== -->

    <div id="tabContent">
        <!-- ====================================== -->
        <!-- start: trade                           -->
        <!-- ====================================== -->
        <div id="tradeTabContent" class="display--flex flex-direction--column border--1 padding--1em">
            <div>
                <h2>
                    <img class="icon" th:src="@{/static/image/icon-detail.svg}" alt="detail"/>
                    <span data-th-text="#{fintics.Trade}"></span>
                </h2>
            </div>
            <div class="display--flex flex-direction--column gap--1em padding--1em s__padding-y--0">
                <form class="display--grid grid-template-columns--12 grid-gap--1em grid-column-gap--2em">
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.name}" class="font-weight--bold tag-required"></span>
                        <input type="text" data-duice-bind="trade" data-duice-property="name"
                               class="width--100 font-weight--bold"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.enabled}" class="font-weight--bold tag-required"></span>
                        <br/>
                        <input type="checkbox" data-duice-bind="trade" data-duice-property="enabled"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.interval}" class="font-weight--bold tag-required"></span>
                        <input type="number" data-duice-bind="trade" data-duice-property="interval" class="width--100 number"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.threshold}" class="font-weight--bold tag-required"></span>
                        <input type="number" data-duice-bind="trade" data-duice-property="threshold" class="width--100 number"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.startAt}" class="font-weight--bold"></span>
                        <input type="time" data-duice-bind="trade" data-duice-property="startAt" class="width--100 date"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.endAt}" class="font-weight--bold"></span>
                        <input type="time" data-duice-bind="trade" data-duice-property="endAt" class="width--100 date"/>
                    </label>
                    <label class="grid-column--12">
                        <span data-th-text="#{fintics.Trade.alarmId}" class="font-weight--bold width--100"></span>
                        <select data-duice-bind="trade"
                                data-duice-property="alarmId"
                                data-duice-option="alarms"
                                data-duice-option-value-property="alarmId"
                                data-duice-option-text-property="name"
                                class="width--100">
                            <option data-th-text="'- '+#{web.global.select}+' -'"></option>
                        </select>
                    </label>
                    <div class="grid-column--12">
                        <label>
                            <input type="checkbox" data-duice-bind="trade" data-duice-property="alarmOnError"/>
                            <span data-th-text="#{fintics.Trade.alarmOnError}" class="font-weight--bold"></span>
                        </label>
                        &nbsp;
                        <label>
                            <input type="checkbox" data-duice-bind="trade" data-duice-property="alarmOnOrder"/>
                            <span data-th-text="#{fintics.Trade.alarmOnOrder}" class="font-weight--bold"></span>
                        </label>
                    </div>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.investAmount}" class="font-weight--bold tag-required"></span>
                        <input type="number" data-duice-bind="trade" data-duice-property="investAmount" data-duice-format="number" class="width--100 font-weight--bold color--red number"/>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.orderKind}" class="font-weight--bold tag-required"></span>
                        <select data-duice-bind="trade" data-duice-property="orderKind" class="width--100">
                            <option data-th-text="'- ' + #{web.global.select} + ' -'"></option>
                            <option th:each="orderKind : ${orderKinds}" th:value="${orderKind}" th:text="#{'fintics.Order.Kind.'+${orderKind}}"></option>
                        </select>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.cashAssetId}" class="font-weight--bold"></span>
                        <div class="width--100">
                            <input type="hidden" data-duice-bind="trade" data-duice-property="cashAssetId"/>
                            <input type="text" data-duice-bind="cashAsset" data-duice-property="name" class="width--50"/>
                            <button type="button" onclick="selectCashAsset();" class="small">
                                <img class="icon" th:src="@{/static/image/icon-search.svg}" alt="asset"/>
                            </button>
                            <button type="button" onclick="clearCashAsset();" class="small">
                                <img class="icon" th:src="@{/static/image/icon-clear.svg}" alt="clear"/>
                            </button>
                        </div>
                    </label>
                    <label class="grid-column--6">
                        <span data-th-text="#{fintics.Trade.cashBufferWeight}" class="font-weight--bold"></span>
                        <div class="width--100">
                            <input type="number" data-duice-bind="trade" data-duice-property="cashBufferWeight" data-duice-format="number" class="width--50 number"/>
                            <span class="code">%</span>
                        </div>
                    </label>
                    <label class="grid-column--12">
                    <span class="width--100">
                        <img class="icon" th:src="@{/static/image/icon-broker.svg}" alt="basket"/>
                        <span data-th-text="#{fintics.Broker}" class="font-weight--bold"></span>
                    </span>
                        <select data-duice-bind="trade"
                                data-duice-property="brokerId"
                                data-duice-option="brokers"
                                data-duice-option-value-property="brokerId"
                                data-duice-option-text-property="name"
                                class="width--100">
                            <option data-th-text="'- '+#{web.global.select}+' -'"></option>
                        </select>
                    </label>
                    <label class="grid-column--12">
                    <span>
                        <img class="icon" th:src="@{/static/image/icon-basket.svg}" alt="basket"/>
                        <span data-th-text="#{fintics.Basket}" class="font-weight--bold"></span>
                    </span>
                        <select data-duice-bind="trade"
                                data-duice-property="basketId"
                                data-duice-option="baskets"
                                data-duice-option-value-property="basketId"
                                data-duice-option-text-property="name"
                                class="width--100">
                            <option data-th-text="'- '+#{web.global.select}+' -'"></option>
                        </select>
                    </label>
                    <div class="grid-column--12 overflow-x--scroll">
                        <span data-th-text="#{fintics.BasketAsset}" class="font-weight--bold width--100"></span>
                        <table class="width--100">
                            <colgroup>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col style="width:15em;"/>
                                <col style="width:5em;"/>
                                <col style="width:5em;"/>
                                <col style="width:5em;"/>
                                <col style="width:7em;"/>
                                <col style="width:15em;"/>
                            </colgroup>
                            <thead>
                            <tr>
                                <th data-th-text="#{web.global.no}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.symbol}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.name}"></th>
                                <th data-th-text="#{fintics.Asset.exchange}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.type}" class="text-align--center"></th>
                                <th></th>
                                <th data-th-text="#{fintics.Asset.links}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.BasketAsset.fixed}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.BasketAsset.enabled}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.BasketAsset.holdingWeight}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.BasketAsset.variables}" class="text-align--center"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr data-duice-bind="basket.basketAssets" data-duice-loop="basketAsset,status">
                                <td class="text-align--center">
                                    <span data-duice-bind="status" data-duice-property="count" class="number"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="basketAsset" data-duice-property="symbol" class="code font-weight--bold"></span>
                                </td>
                                <td class="text-align--left">
                                    <img class="icon icon--circle font-size--large" data-duice-bind="basketAsset" data-duice-property="icon" th:onerror="|null; this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                                    &nbsp;
                                    <span data-duice-bind="basketAsset" data-duice-property="name"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="basketAsset" data-duice-property="exchange" class="badge"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="basketAsset" data-duice-property="type" class="badge"></span>
                                </td>
                                <td>
                                    <div class="overflow-y--scroll border--1 padding--1px" style="line-height:1em; height:5em;">
                                        <table class="width--100 border--0 font-size--smaller code">
                                            <colgroup>
                                                <col class="width--50"/>
                                                <col class="width--50"/>
                                            </colgroup>
                                            <tbody>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.marketCap}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="marketCap" data-duice-format="number" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.eps}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="eps" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.roe}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="roe" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.roa}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="roa" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.per}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="per" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.dividendYield}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="dividendYield" class="text-align--right"></td>
                                            </tr>
                                            <tr>
                                                <td data-th-text="#{fintics.Asset.dividendFrequency}"></td>
                                                <td data-duice-bind="basketAsset" data-duice-property="dividendFrequency" class="text-align--right"></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                                <td class="text-align--center">
                                    <select data-duice-bind="basketAsset"
                                            data-duice-option="basketAsset.links"
                                            data-duice-option-value-property="url"
                                            data-duice-option-text-property="name"
                                            onchange="_openLink(this.value, '_blank'); this.value = '';"
                                            class="code font-size--smaller">
                                        <option value>Link...</option>
                                    </select>
                                </td>
                                <td class="text-align--center">
                                    <label>
                                        <input type="checkbox" data-duice-bind="basketAsset"
                                               data-duice-property="fixed"/>
                                    </label>
                                </td>
                                <td class="text-align--center">
                                    <label>
                                        <input type="checkbox" data-duice-bind="basketAsset"
                                               data-duice-property="enabled"/>
                                    </label>
                                </td>
                                <td class="text-align--center">
                                    <label>
                                        <input type="number"
                                               data-duice-bind="basketAsset"
                                               data-duice-property="holdingWeight"
                                               class="width--50 number"/><span class="code">%</span>
                                    </label>
                                </td>
                                <td>
                                    <label class="display--flex">
                                        <textarea data-duice-bind="basketAsset" data-duice-property="variables" class="width--100 height--100 code"></textarea>
                                    </label>
                                </td>
                            </tr>
                            <tr data-duice-bind="basket.basketAssets"
                                data-duice-execute="if(basket.basketAssets.length === 0) this.hidden=false;" hidden>
                                <td colspan="100%" class="text-align--center">No Data</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <label class="grid-column--12">
                    <span class="width--100">
                        <img class="icon" th:src="@{/static/image/icon-strategy.svg}" alt="strategy"/>
                        <span data-th-text="#{fintics.Strategy}" class="font-weight--bold width--100"></span>
                    </span>
                        <select data-duice-bind="trade"
                                data-duice-property="strategyId"
                                data-duice-option="strategies"
                                data-duice-option-value-property="strategyId"
                                data-duice-option-text-property="name"
                                class="width--100">
                            <option data-th-text="'- '+#{web.global.select}+' -'" value></option>
                        </select>
                    </label>
                    <div class="grid-column--12">
                        <div>
                            <span data-th-text="#{fintics.Trade.strategyVariables}" class="font-weight--bold width--100"></span>
                        </div>
                        <duice-codemirror class="code border--1"
                                          data-duice-bind="trade"
                                          data-duice-property="strategyVariables">
                        </duice-codemirror>
                    </div>
                    <div class="grid-column--12">
                        <div class="display--flex justify-content--space-between margin--1px padding--1px">
                            <div>
                                <span data-th-text="#{fintics.Strategy.script}" class="font-weight--bold width--100"></span>
                            </div>
                        </div>
                        <duice-codemirror class="code" style="height:100vh;"
                                          data-duice-bind="strategy"
                                          data-duice-property="script"
                                          data-duice-mode="groovy"
                                          data-duice-theme="dracula">
                        </duice-codemirror>
                    </div>
                </form>
                <div class="display--flex justify-content--space-between">
                    <div>
                        <button type="button"
                                th:classappend="!${#authorization.expression('hasAuthority(''trade.edit'')')}?'locked'"
                                onclick="exportTrade();">
                            <img class="icon" th:src="@{/static/image/icon-export.svg}" alt="export"/>
                            <span>Export</span>
                        </button>
                        <button type="button"
                                th:classappend="!${#authorization.expression('hasAuthority(''trade.edit'')')}?'locked'"
                                onclick="importTrade();">
                            <img class="icon" th:src="@{/static/image/icon-import.svg}" alt="import"/>
                            <span>Import</span>
                        </button>
                    </div>
                    <div>
                        <button type="button"
                                data-duice-bind="trade"
                                data-duice-execute="this.disabled=(trade._new);"
                                th:classappend="!${#authorization.expression('hasAuthority(''trade.edit'')')}?'locked'"
                                onclick="deleteTrade();">
                            <img class="icon" th:src="@{/static/image/icon-delete.svg}" alt="save"/>
                            <span data-th-text="#{web.global.delete}"></span>
                        </button>
                        <button type="button"
                                data-duice-bind="trade"
                                th:classappend="!${#authorization.expression('hasAuthority(''trade.edit'')')}?'locked'"
                                onclick="saveTrade();">
                            <img class="icon" th:src="@{/static/image/icon-save.svg}" alt="save"/>
                            <span data-th-text="#{web.global.save}"></span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
        <!-- ====================================== -->
        <!-- end: trade                             -->
        <!-- ====================================== -->

        <!-- ====================================== -->
        <!-- start: cash asset dialog               -->
        <!-- ====================================== -->
        <dialog id="cashAssetDialog">
            <style th:inline="css">
                #cashAssetDialog {
                    width: 1024px;
                }
            </style>
            <script th:inline="javascript">
                const cashAssetDialog = {
                    dialog: new duice.dialog.Dialog(document.getElementById('cashAssetDialog')),
                    assetSearch: new duice.ObjectProxy({
                        market: null,
                        type: null,
                        key: 'name',
                        value: null,
                        _page: 0,
                        _size: 5,
                        _count: 0
                    }),
                    assets: new duice.ArrayProxy([]),
                    open: async function() {
                        await this.getAssets(0);
                        return this.dialog.open();
                    },
                    getAssets: async function(page) {
                        this.assetSearch._page = page || 0;
                        let url = new URL(`${_apiUrl}/v1/assets`, document.location.origin);
                        if (this.assetSearch.market) {
                            url.searchParams.append('market', this.assetSearch.market);
                        }
                        if (this.assetSearch.type) {
                            url.searchParams.append('type', this.assetSearch.type);
                        }
                        if (this.assetSearch.key && this.assetSearch.value) {
                            url.searchParams.append(this.assetSearch.key, this.assetSearch.value);
                        }
                        url.searchParams.append('_page', this.assetSearch._page);
                        url.searchParams.append('_size', this.assetSearch._size);
                        await _fetch(url)
                            .then(response => {
                                this.assetSearch._count = _parseTotalCount(response);
                                return response.json();
                            })
                            .then(data => {
                                duice.ArrayProxy.clear(this.assets);
                                duice.ArrayProxy.assign(this.assets, data);
                            });
                    },
                    selectAsset: function(index) {
                        let asset = JSON.parse(JSON.stringify(this.assets[index]));
                        this.dialog.close(asset);
                    }
                }
            </script>
            <div class="display--flex flex-direction--column padding--1em">
                <div>
                    <h2>
                        <img class="icon" th:src="@{/static/image/icon-asset.svg}" alt="asset"/>
                        <span data-th-text="#{fintics.Trade.cashAssetId} + ' ' + #{web.global.select}"></span>
                    </h2>
                </div>
                <div class="display--flex flex-direction--column gap--1em padding--1em">
                    <form onsubmit="return false;" class="display--grid grid-template-columns--12 grid-gap--1em">
                        <label class="grid-column--2 s__grid-column--12">
                            <select data-duice-bind="cashAssetDialog.assetSearch" data-duice-property="market" class="width--100">
                                <option value="" data-th-text="'- ' + #{fintics.Asset.market} + ' -'"></option>
                                <option th:each="market : ${markets}" th:value="${market}" th:text="${market}"></option>
                            </select>
                        </label>
                        <label class="grid-column--2 s__grid-column--12">
                            <select data-duice-bind="cashAssetDialog.assetSearch" data-duice-property="type" class="width--100">
                                <option value="" data-th-text="'- ' + #{fintics.Asset.type} + ' -'"></option>
                                <option value="STOCK">STOCK</option>
                                <option value="ETF">ETF</option>
                            </select>
                        </label>
                        <label class="grid-column--2 s-grid-column-4">
                            <select class="width--100" data-duice-bind="cashAssetDialog.assetSearch" data-duice-property="key">
                                <option value="name" th:text="#{fintics.Asset.name}"></option>
                                <option value="assetId" th:text="#{fintics.Asset.assetId}"></option>
                            </select>
                        </label>
                        <label class="grid-column--2 s-grid-column--8">
                            <input class="width--100" type="text" data-duice-bind="cashAssetDialog.assetSearch" data-duice-property="value"/>
                        </label>
                        <div class="grid-column--4 s-grid-column--12 justify-self--end">
                            <button onclick="cashAssetDialog.getAssets();">
                                <img class="icon" th:src="@{/static/image/icon-search.svg}" alt="search"/>
                                <span data-th-text="#{web.global.search}">Search</span>
                            </button>
                            <button onclick="cashAssetDialog.resetAssets();">
                                <img class="icon" th:src="@{/static/image/icon-reset.svg}" alt="reset"/>
                                <span data-th-text="#{web.global.reset}">Reset</span>
                            </button>
                        </div>
                    </form>
                    <div class="overflow-x--scroll">
                        <table class="width--100">
                            <colgroup>
                                <col style="width:3em;"/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                            </colgroup>
                            <thead>
                            <tr>
                                <th></th>
                                <th data-th-text="#{fintics.Asset.symbol}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.name}"></th>
                                <th data-th-text="#{fintics.Asset.exchange}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.type}" class="text-align--center"></th>
                                <th data-th-text="#{fintics.Asset.marketCap}" class="text-align--right"></th>
                                <th data-th-text="#{fintics.Asset.links}" class="text-align--center"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr data-duice-bind="cashAssetDialog.assets" data-duice-loop="asset,status">
                                <td class="text-align--center">
                                    <button class="small" type="button"
                                            data-duice-bind="asset"
                                            data-duice-execute="
                        this.dataset.index = status.index;
                        if(asset._selected) {
                            this.disabled = true;
                        }"
                                            onclick="cashAssetDialog.selectAsset(this.dataset.index);">
                                        <img class="icon" th:src="@{/static/image/icon-add.svg}" alt="add"/>
                                    </button>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="asset" data-duice-property="symbol" class="code font-weight--bold"></span>
                                </td>
                                <td class="text-align--left" style="overflow-x: hidden;">
                                    <img class="icon" data-duice-bind="asset" data-duice-property="icon" th:onerror="|null; this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                                    &nbsp;
                                    <span data-duice-bind="asset" data-duice-property="name"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="asset" data-duice-property="exchange" class="code badge"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="asset" data-duice-property="type" class="code badge"></span>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="asset" data-duice-property="marketCap" data-duice-format="number" class="number"></span>
                                </td>
                                <td class="text-align--right font-size--smaller code">
                                    <select data-duice-bind="asset"
                                            data-duice-option="asset.links"
                                            data-duice-option-value-property="url"
                                            data-duice-option-text-property="name"
                                            onchange="_openLink(this.value, '_blank'); this.value = '';">
                                        <option value>- Link -</option>
                                    </select>
                                </td>
                            </tr>
                            <tr data-duice-bind="cashAssetDialog.assets"
                                data-duice-execute="if(cashAssetDialog.assets.length === 0) this.hidden=false;" hidden>
                                <td colspan="100%" class="text-align--center font-size--smaller">No Data</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="display--grid grid-template-columns--3">
                        <div class="grid-column--1 display--flex">
                            <span data-th-text="#{web.global.total}"></span>
                            &nbsp;
                            <span data-duice-bind="cashAssetDialog.assetSearch" data-duice-property="_count" data-duice-format="number" class="number"></span>
                            &nbsp;
                            <span data-th-text="#{web.global.rows}"></span>
                        </div>
                        <div class="grid-column--1 display--flex justify-content--center">
                            <duice-pagination
                                    data-duice-bind="cashAssetDialog.assetSearch"
                                    data-duice-size-property="_size"
                                    data-duice-page-property="_page"
                                    data-duice-count-property="_count"
                                    data-duice-onclick="cashAssetDialog.getAssets(this.dataset.page);"
                                    class="number">
                            </duice-pagination>
                        </div>
                        <div class="grid-column--1"></div>
                    </div>
                </div>
            </div>
        </dialog>
        <!-- ====================================== -->
        <!-- end: cash asset dialog                 -->
        <!-- ====================================== -->

        <!-- ================================== -->
        <!-- start: balance                     -->
        <!-- ================================== -->
        <div id="tradeBalanceTabContent" class="display--flex flex-direction--column border--1 padding--1em" style="min-height:400px;">
            <div>
                <h2>
                    <img class="icon" th:src="@{/static/image/icon-balance.svg}" alt="balance"/>
                    <span data-th-text="#{fintics.Balance}"></span>
                </h2>
            </div>
            <div class="display--flex flex-direction--column gap--1em padding--1em s__padding-y--0">
                <div class="display--grid grid-template-columns--12 grid-gap--1em">
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.totalAmount}" class="font-weight--bold"></span>
                        <input type="number" data-duice-bind="balance" data-duice-property="totalAmount" data-duice-format="number" class="width--100 font-weight--bold number"/>
                    </label>
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.cashAmount}" class="font-weight--bold"></span>
                        <input type="number" data-duice-bind="balance" data-duice-property="cashAmount" data-duice-format="number" class="width--100 number"/>
                    </label>
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.purchaseAmount}" class="font-weight--bold"></span>
                        <input type="number" data-duice-bind="balance" data-duice-property="purchaseAmount" data-duice-format="number" class="width--100 number"/>
                    </label>
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.valuationAmount}" class="font-weight--bold width--100"></span>
                        <input type="number" data-duice-bind="balance" data-duice-property="valuationAmount" data-duice-format="number" class="width--100 number"/>
                    </label>
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.profitAmount}" class="font-weight--bold"></span>
                        <input type="number"
                               data-duice-bind="balance"
                               data-duice-property="profitAmount"
                               data-duice-format="number"
                               data-duice-execute="
                           if(balance.profitAmount > 0) this.classList.add('color--green');
                           if(balance.profitAmount < 0) this.classList.add('color--red');
                           "
                               class="width--100 number font-weight--bold"/>
                    </label>
                    <label class="grid-column--6 s__grid-column--12">
                        <span data-th-text="#{fintics.Balance.realizedProfitAmount}" class="font-weight--bold width--100"></span>
                        <input type="number"
                               data-duice-bind="balance"
                               data-duice-property="realizedProfitAmount"
                               data-duice-format="number"
                               data-duice-execute="
                           if(balance.realizedProfitAmount > 0) this.classList.add('color--green');
                           if(balance.realizedProfitAmount < 0) this.classList.add('color--red');
                           "
                               class="width--100 number font-weight--bold"/>
                    </label>
                    <div class="grid-column--12">
                        <span data-th-text="#{fintics.BalanceAsset}" class="font-weight--bold width--100"></span>
                        <div class="overflow-x--scroll">
                            <table class="width--100">
                                <colgroup>
                                    <col style="width:5em;"/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                    <col/>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th data-th-text="#{web.global.no}"></th>
                                    <th data-th-text="#{fintics.Asset.symbol}"></th>
                                    <th data-th-text="#{fintics.Asset.name}"></th>
                                    <th data-th-text="#{fintics.BalanceAsset.quantity}"></th>
                                    <th data-th-text="#{fintics.BalanceAsset.purchaseAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.BalanceAsset.valuationAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.BalanceAsset.profitAmount}" class="text-align--right"></th>
                                    <th data-th-text="#{fintics.BalanceAsset.profitPercentage}" class="text-align--right"></th>
                                    <th class="text-align--right">-</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr data-duice-bind="balance.balanceAssets"
                                    data-duice-loop="balanceAsset,status"
                                    data-duice-execute="
                                    let length = basket.basketAssets.filter(basketAsset => {
                                        return basketAsset.assetId === balanceAsset.assetId;
                                    }).length;
                                    if(length === 0) {
                                        this.style.opacity=0.5;
                                    }">
                                    <td>
                                        <span data-duice-bind="status" data-duice-property="count" class="number"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="balanceAsset" data-duice-property="symbol" class="code font-weight--bold"></span>
                                    </td>
                                    <td>
                                        <img class="icon font-size--large" data-duice-bind="balanceAsset" data-duice-property="icon" th:onerror="|this.onerror=null; this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                                        &nbsp;
                                        <span data-duice-bind="balanceAsset" data-duice-property="name"></span>
                                    </td>
                                    <td>
                                        <span data-duice-bind="balanceAsset" data-duice-property="quantity" data-duice-format="number" class="number"></span>
                                        (<span data-duice-bind="balanceAsset" data-duice-property="orderableQuantity" data-duice-format="number" class="number"></span>)
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="balanceAsset" data-duice-property="purchaseAmount" data-duice-format="number" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                        <span data-duice-bind="balanceAsset" data-duice-property="valuationAmount" data-duice-format="number" class="number"></span>
                                    </td>
                                    <td class="text-align--right">
                                    <span data-duice-bind="balanceAsset"
                                          data-duice-property="profitAmount"
                                          data-duice-format="number"
                                          data-duice-execute="
                                          if(balanceAsset.profitAmount > 0) this.classList.add('color--green');
                                          if(balanceAsset.profitAmount < 0) this.classList.add('color--red');
                                          " class="number font-weight--bold">
                                    </span>
                                    </td>
                                    <td data-duice-bind="balanceAsset" data-duice-execute="
                                if(balanceAsset.profitPercentage > 0) this.classList.add('color--green');
                                if(balanceAsset.profitPercentage < 0) this.classList.add('color--red');
                                " class="text-align--right">
                                        <span data-duice-bind="balanceAsset" data-duice-property="profitPercentage" data-duice-format="number" class="number font-weight--bold"></span>
                                        <span class="code">%</span>
                                    </td>
                                    <td class="text-align--right">
                                        <button class="small" type="button"
                                                data-duice-bind="balanceAsset"
                                                data-duice-execute="this.dataset.assetId=balanceAsset.assetId;"
                                                onclick="sellBalanceAsset(this.dataset.assetId);"
                                                th:classappend="!${#authorization.expression('hasAuthority(''trade.edit'')')}?'locked'">
                                            <img class="icon" th:src="@{/static/image/icon-order-sell.svg}" alt="sell"/>
                                            <span data-th-text="#{fintics.Order.Type.SELL}"></span>
                                        </button>
                                    </td>
                                </tr>
                                <tr data-duice-bind="balance.balanceAssets" data-duice-execute="if(balance.balanceAssets.length === 0) this.hidden=false;" hidden>
                                    <td colspan="100%" class="text-align--center">No Data</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ====================================== -->
        <!-- end: balance                           -->
        <!-- ====================================== -->
    </div>

    <th:block th:fragment="submitOrderDialog">
        <!-- ================================== -->
        <!-- submit order dialog                -->
        <!-- ================================== -->
        <dialog id="submitOrderDialog">
            <style th:inline="css">
                #submitOrderDialog {
                    width: 600px;
                }
            </style>
            <script th:inline="javascript">
                const submitOrderDialog = {
                    dialog: new duice.dialog.Dialog(document.getElementById('submitOrderDialog')),
                    order: new duice.ObjectProxy({
                        tradeId: null,
                        tradeName: null,
                        assetId: null,
                        assetName: null,
                        type: null,
                        kind: 'MARKET',
                        quantity: 1
                    }),
                    open: async function(trade, asset, type) {
                        duice.ObjectProxy.reset(this.order);
                        this.order.tradeId = trade.tradeId;
                        this.order.tradeName = trade.name;
                        this.order.assetId = asset.assetId;
                        this.order.assetName = asset.name;
                        this.order.type = type;
                        return this.dialog.open();
                    },
                    confirm: async function() {
                        if(!this.order.quantity) {
                            await _alert(/*[[#{web.global.itemEmpty(#{fintics.Order.quantity})}]]*/'');
                            duice.ObjectProxy.focus(this.order, 'quantity');
                            return false;
                        }
                        _confirm(/*[[#{web.global.requestItemConfirm(#{fintics.Order})}]]*/'')
                            .then(result => {
                                let url = new URL(`${_apiUrl}/v1/trades/${this.order.tradeId}/orders`, document.location.origin);
                                if (result) {
                                    _fetch(url, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(this.order)
                                    }).then(response => response.json())
                                        .then(data => {
                                            _alert(/*[[#{web.global.requestItemComplete(#{fintics.Order})}]]*/'')
                                                .then(() => {
                                                    this.dialog.close();
                                                });
                                        });
                                }
                            });
                    }
                }
            </script>
            <div class="display--flex flex-direction--column padding--1em">
                <div>
                    <h2>
                        <img class="icon" th:src="@{/static/image/icon-order.svg}" alt="asset"/>
                        <span data-th-text="#{fintics.Order}"></span>
                    </h2>
                </div>
                <div class="display--flex flex-direction--column gap--1em padding--1em">
                    <form onsubmit="return false;" class="display--grid grid-template-columns--12 grid-gap--1em">
                        <label class="grid-column--6">
                            <span data-th-text="#{fintics.Trade}" class="font-weight--bold"></span>
                            <input type="text" data-duice-bind="submitOrderDialog.order" data-duice-property="tradeName" class="width--100"/>
                        </label>
                        <label class="grid-column--6">
                            <span data-th-text="#{fintics.Asset}" class="font-weight--bold"></span>
                            <input type="text" data-duice-bind="submitOrderDialog.order" data-duice-property="assetName" class="width--100"/>
                        </label>
                        <label class="grid-column--6">
                            <span data-th-text="#{fintics.Order.type}" class="font-weight--bold"></span>
                            <select data-duice-bind="submitOrderDialog.order" data-duice-property="type" class="width--100">
                                <option value="BUY" data-th-text="#{fintics.Order.Type.BUY}"></option>
                                <option value="SELL" data-th-text="#{fintics.Order.Type.SELL}"></option>
                            </select>
                        </label>
                        <label class="grid-column--6">
                            <span data-th-text="#{fintics.Order.kind}" class="font-weight--bold"></span>
                            <select data-duice-bind="submitOrderDialog.order" data-duice-property="kind" class="width--100">
                                <option value="MARKET" data-th-text="#{fintics.Order.Kind.MARKET}"></option>
                                <option value="LIMIT" data-th-text="#{fintics.Order.Kind.LIMIT}"></option>
                            </select>
                        </label>
                        <label class="grid-column--6">
                            <span data-th-text="#{fintics.Order.quantity}" class="font-weight--bold"></span>
                            <input type="number" data-duice-bind="submitOrderDialog.order" data-duice-property="quantity" class="width--100"/>
                        </label>
                    </form>
                    <div class="display--flex justify-content--flex-end">
                        <button onclick="submitOrderDialog.confirm();">
                            <img class="icon" th:src="@{/static/image/icon-confirm.svg}" alt="confirm"/>
                            <span data-th-text="#{web.global.confirm}"></span>
                        </button>
                    </div>
                </div>
            </div>
        </dialog>
        <!-- ================================== -->
        <!-- submit order dialog                -->
        <!-- ================================== -->
    </th:block>

</th:block>
