<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<th:block layout:fragment="_content">
    <script th:src="@{/static/fintics.js?version={version}(version=${_scriptVersion})}"></script>
    <script th:inline="javascript">
        Chart.defaults.font.size = 8;
        Chart.defaults.animation = false;
        const trades = new duice.ArrayProxy(/*[[${trades}]]*/[]);
        const baskets = new duice.ArrayProxy(/*[[${baskets}]]*/[]);
        trades.forEach(trade => {
            // newses
            trade['newses'] = new duice.ArrayProxy([]);

            // basket
            let basket = baskets.find(it => it.basketId === trade.basketId);
            trade['basket'] = basket || new duice.ObjectProxy({
                basketAssets: []
            });

            // balance
            trade['balance'] = new duice.ObjectProxy({});
        });

        /**
         * initializes trade daily chart
         * @param tradeId trade id
         */
        function initializeTradeDailyOhlcvs(tradeId) {
            let trade = trades.find(it => it.tradeId === tradeId);
            trade.dailyOhlcvsChart = _createDailyOhlcvsChart(`tradeDailyOhlcvsChart-${trade.tradeId}`);
        }

        /**
         * initializes trade minute ohlcv
         * @param tradeId
         */
        function initializeTradeMinuteOhlcvs(tradeId) {
            let trade = trades.find(it => it.tradeId === tradeId);
            trade.minuteOhlcvsChart = _createMinuteOhlcvsChart(`tradeMinuteOhlcvsChart-${trade.tradeId}`);
        }

        /**
         * gets trade daily ohlcvs
         * @param tradeId trade id
         */
        function getTradeDailyOhlcvs(tradeId) {
            let trade = trades.find(it => it.tradeId === tradeId);
            let dailyOhlcvsChart = trade.dailyOhlcvsChart;
            const now = new Date();
            dailyOhlcvsChart.options.scales.x.max = now;
            dailyOhlcvsChart.data.datasets.length = 0;
            // daily
            const promises = trade.basket.basketAssets
                .filter(basketAsset => basketAsset.enabled)
                .map(async basketAsset => {
                    let url = new URL(`${_apiUrl}/v1/ohlcvs/${basketAsset.assetId}/daily`, document.location.origin);
                    return _fetch(url, null, true)
                        .then(response => response.json())
                        .then(ohlcvs => {
                            let timeSeries = _createTimeSeries(ohlcvs);
                            return {
                                label: basketAsset.assetName,
                                data: timeSeries,
                                borderWidth: 1,
                                pointStyle: false
                            };
                        });
                });
            Promise.all(promises).then(results => {
                results.forEach(dataset => dailyOhlcvsChart.data.datasets.push(dataset));
                dailyOhlcvsChart.update();
            });
        }

        /**
         * gets trade minute ohlcvs
         * @param tradeId trade id
         */
        function getTradeMinuteOhlcvs(tradeId) {
            let trade = trades.find(it => it.tradeId === tradeId);
            let minuteOhlcvsChart = trade.minuteOhlcvsChart;
            const now = new Date();
            minuteOhlcvsChart.options.scales.x.max = now;
            minuteOhlcvsChart.data.datasets.length = 0;
            // daily
            const promises = trade.basket.basketAssets
                .filter(basketAsset => basketAsset.enabled)
                .map(async basketAsset => {
                    let url = new URL(`${_apiUrl}/v1/ohlcvs/${basketAsset.assetId}/minute`, document.location.origin);
                    return _fetch(url, null, true)
                        .then(response => response.json())
                        .then(ohlcvs => {
                            let timeSeries = _createTimeSeries(ohlcvs);
                            return {
                                label: basketAsset.assetName,
                                data: timeSeries,
                                borderWidth: 1,
                                pointStyle: false
                            };
                        });
                });
            Promise.all(promises).then(results => {
                results.forEach(dataset => minuteOhlcvsChart.data.datasets.push(dataset));
                minuteOhlcvsChart.update();
            });
        }

        /**
         * gets trade newses
         * @param tradeId trade id
         */
        function getTradeNewses(tradeId) {
            let trade = trades.find(it => it.tradeId === tradeId);
            // news
            let newsPromises = trade.basket.basketAssets.map(asset => {
                let url = new URL(`${_apiUrl}/v1/newses/${asset.assetId}`, document.location.origin);
                return _fetch(url, null, true)
                    .then(response => response.json())
                    .then(newses => {
                        newses.forEach(it => {
                            it.assetId = asset.assetId;
                            it.assetName = asset.assetName;
                        });
                        return newses;
                    });
            });
            Promise.all(newsPromises).then(results => {
                let newses = [];
                results.forEach(result => {
                    newses.push.apply(newses, result);
                });
                newses.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                applyTradeNewses(tradeId, newses);
            });
        }

        /**
         * applies trade newses
         * @param tradeId trade id
         * @param newses array of news
         */
        function applyTradeNewses(tradeId, newses) {
            let trade = trades.find(it => it.tradeId === tradeId);
            if (trade) {
                duice.ArrayProxy.assign(trade.newses, newses);
            }
        }

        /**
         * gets trade assets
         * @param tradeId trade id
         */
        function getTradeAssets(tradeId) {
            let url = new URL(`${_apiUrl}/v1/trades/${tradeId}/assets`, document.location.origin);
            _fetch(url, null, true)
                .then(response => response.json())
                .then(tradeAssets => {
                    tradeAssets.forEach(tradeAsset => {
                        applyTradeAsset(tradeAsset);
                    });
                });
        }

        /**
         * applies trade asset
         * @param tradeAsset trade asset
         */
        function applyTradeAsset(tradeAsset) {
            let trade = trades.find(it => it.tradeId === tradeAsset.tradeId);
            if (trade) {
                let basketAsset = trade.basket.basketAssets.find(it => it.assetId === tradeAsset.assetId);
                if (basketAsset) {
                    basketAsset.close = tradeAsset.close;
                    basketAsset.netChange = tradeAsset.netChange;
                    basketAsset.netChangePercentage = tradeAsset.netChangePercentage;
                    basketAsset.intraDayNetChange = tradeAsset.intraDayNetChange;
                    basketAsset.intraDayNetChangePercentage = tradeAsset.intraDayNetChangePercentage;
                    basketAsset.message = tradeAsset.message;
                }
            }
        }

        /**
         * gets trade balance
         * @param tradeId trade id
         */
        function getTradeBalance(tradeId) {
            let url = new URL(`${_apiUrl}/v1/trades/${tradeId}/balance`, document.location.origin);
            _fetch(url, null, true)
                .then(response => response.json())
                .then(balance => {
                    applyTradeBalance(tradeId, balance);
                });
        }

        /**
         * applies trade balance
         * @param tradeId trade id
         * @param balance balance
         */
        function applyTradeBalance(tradeId, balance) {
            let trade = trades.find(it => it.tradeId === tradeId);
            duice.ObjectProxy.assign(trade.balance, balance);
            balance.balanceAssets.forEach(balanceAsset => {
                let basketAsset = trade.basket.basketAssets.find(it => it.assetId === balanceAsset.assetId);
                if (basketAsset) {
                    basketAsset.quantity = balanceAsset.quantity;
                    basketAsset.orderableQuantity = balanceAsset.orderableQuantity;
                    basketAsset.purchasePrice = balanceAsset.purchasePrice;
                    basketAsset.purchaseAmount = balanceAsset.purchaseAmount;
                    basketAsset.valuationPrice = balanceAsset.valuationPrice;
                    basketAsset.valuationAmount = balanceAsset.valuationAmount;
                    basketAsset.profitAmount = balanceAsset.profitAmount;
                    basketAsset.profitPercentage = balanceAsset.profitPercentage;
                }
            });
        }

        /**
         * initializes all trade monitors
         */
        function initializeTradeMonitors() {
            trades.forEach(trade => {
                // daily chart
                initializeTradeDailyOhlcvs(trade.tradeId);
                // minute chart
                initializeTradeMinuteOhlcvs(trade.tradeId);
            });
        }

        /**
         * gets all trade monitors
         */
        function getTradeMonitors() {
            trades.forEach(trade => {
                // daily ohlcvs
                getTradeDailyOhlcvs(trade.tradeId);
                // minute ohlcvs
                getTradeMinuteOhlcvs(trade.tradeId);
                // new newses
                getTradeNewses(trade.tradeId);
                // status
                getTradeAssets(trade.tradeId);
                // new balance
                getTradeBalance(trade.tradeId);
            });
        }

        /**
         * opens trade view
         * @param tradeId trade id
         */
        function openTrade(tradeId) {
            _openLink(`${_rootUrl}/trade?tradeId=${tradeId}`, '_blank');
        }

        /**
         * on DOM content loaded
         */
        document.addEventListener('DOMContentLoaded', () => {
            let tabItems = trades.map(trade => {
                return duice.tabItem(
                    document.getElementById(`tradeTabButton-${trade.tradeId}`),
                    document.getElementById(`tradeTabContent-${trade.tradeId}`),
                    () => {}
                );
            });
            let tabFolder = duice.tabFolder(...tabItems);
            tabFolder.setActive(0);

            // initialize
            initializeTradeMonitors();

            // refresh
            getTradeMonitors();
            setInterval(function() {
                getTradeMonitors();
            }, 1000*60);
        });
    </script>
    <style th:inline="css">
        .tradeLog {
            padding-top: 0.5em;
            line-height: 1.2em;
            background-color: #222;
            color: white;
            font-family: monospace;
            font-size: xx-small;
        }
    </style>

    <!-- ====================================== -->
    <!-- start: title                           -->
    <!-- ====================================== -->
    <h1 id="title">
        <img class="icon" th:src="@{/static/image/icon-monitor.svg}" alt="monitor"/>
        <span data-th-text="#{web.global.monitor}"></span>
    </h1>
    <!-- ====================================== -->
    <!-- end: title                             -->
    <!-- ====================================== -->

    <!-- ====================================== -->
    <!-- start: tab index                       -->
    <!-- ====================================== -->
    <div id="tabIndex" class="display--flex flex-wrap--nowrap overflow-x--scroll gap--1px margin-bottom--1px margin-top--1em">
        <button th:each="trade : ${trades}" th:id="|tradeTabButton-${trade.tradeId}|" type="button" class="tab" style="flex-shrink:0;">
            <img class="icon" th:src="@{/static/image/icon-trade.svg}" alt="simulate"/>
            <span data-th-text="${trade.tradeName}"></span>
        </button>
    </div>
    <!-- ====================================== -->
    <!-- end: tab index                         -->
    <!-- ====================================== -->

    <!-- ================================== -->
    <!-- start: trade                       -->
    <!-- ================================== -->
    <div th:each="trade : ${trades}" th:id="|tradeTabContent-${trade.tradeId}|" class="grid-column--12 border--1 padding--1em">
        <script th:inline="javascript">
            _webSocketClient.subscribe({
                destination: '/trades/' + [[${trade.tradeId}]] + '/logs',
                listener: function(frame) {
                    let tradeLog = document.getElementById('tradeLog-' + [[${trade.tradeId}]]);
                    if (tradeLog.value.length > 1024 * 1024) {
                        tradeLog.value = '';
                    }
                    tradeLog.value += frame.body + '\n';
                    tradeLog.scrollTop = tradeLog.scrollHeight;
                }
            });
            _webSocketClient.subscribe({
                destination: '/trades/' + [[${trade.tradeId}]] + '/assets',
                listener: function(frame) {
                    let tradeAsset = JSON.parse(frame.body);
                    applyTradeAsset(tradeAsset);
                }
            });
        </script>
        <h2>
            <img class="icon" th:src="@{/static/image/icon-trade.svg}" alt="trade"/>
            <span data-th-text="${trade.tradeName}"></span>
            <a href="#" th:data-trade-id="${trade.tradeId}" onclick="openTrade(this.dataset.tradeId);">
                <small>
                    <img class="icon link" th:src="@{/static/image/icon-open.svg}" alt="trade"/>
                </small>
            </a>
        </h2>
        <div class="display--grid grid-template-columns--12 padding--1em s__padding--0">
            <div class="grid-column--6 s__grid-column--12" style="height:150px;">
                <div class="font-weight--bold">
                    <img class="icon" src="/static/image/icon-ohlcv.svg" alt="ohlcv">
                    <span>Daily</span>
                </div>
                <canvas th:id="'tradeDailyOhlcvsChart-' + ${trade.tradeId}"></canvas>
            </div>
            <div class="grid-column--6 s__grid-column--12" style="height:150px;">
                <div class="font-weight--bold">
                    <img class="icon" src="/static/image/icon-ohlcv.svg" alt="ohlcv">
                    <span>Minute</span>
                </div>
                <canvas th:id="'tradeMinuteOhlcvsChart-' + ${trade.tradeId}"></canvas>
            </div>
        </div>
        <div class="grid-column--12 padding--1em s__padding--0">
            <div class="font-weight--bold">
                <img class="icon" src="/static/image/icon-news.svg" alt="ohlcv">
                <span data-th-text="#{fintics.News}"></span>
            </div>
            <div class="overflow-y--scroll overflow-x--scroll border-top--1" style="max-height:150px;">
                <table class="width--100 font-size--smaller border-top--0" style="line-height:normal;">
                    <colgroup>
                        <col style="width:10em;"/>
                        <col/>
                        <col/>
                        <col style="width:10em;"/>
                        <col style="width:10em;"/>
                    </colgroup>
                    <thead>
                    <tr>
                        <th data-th-text="#{fintics.News.dateTime}"></th>
                        <th data-th-text="#{fintics.Asset}"></th>
                        <th data-th-text="#{fintics.News.title}"></th>
                        <th data-th-text="#{fintics.News.sentiment}" class="text-align--center"></th>
                        <th data-th-text="#{fintics.News.confidence}" class="text-align--center"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').newses|" data-duice-loop="news,status" class="font-size--smaller">
                        <td data-duice-bind="news" data-duice-property="dateTime" data-duice-format="date('yyyy-MM-dd HH:mm:ss')"></td>
                        <td data-duice-bind="news" data-duice-property="assetName"></td>
                        <td>
                            <a href="#" onclick="_openLink(this.dataset.newsUrl,'_blank');" data-duice-bind="news" data-duice-property="title" data-duice-execute="this.dataset.newsUrl=news.newsUrl;">
                            </a>
                        </td>
                        <td data-duice-bind="news" data-duice-property="sentiment" class="text-align--center"></td>
                        <td data-duice-bind="news" data-duice-property="confidence" class="text-align--center"></td>
                    </tr>
                    <tr th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').newses|"
                        th:data-duice-if="|return trades.find(it => it.tradeId === '${trade.tradeId}').newses.length < 1|"
                        hidden>
                        <td colspan="100%" class="text-align--center">
                            <span data-th-text="#{web.global.itemNotFound(#{fintics.News})}"></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="grid-column--12 padding--1em s__padding--0">
            <div>
                <img class="icon" data-th-src="@{/static/image/icon-log.svg}" alt="log"/>
                <span class="font-weight--bold" data-th-text="#{web.global.log}"></span>
            </div>
            <div style="height:200px;">
                <textarea th:id="'tradeLog-' + ${trade.tradeId}" class="tradeLog width--100 height--100"></textarea>
            </div>
        </div>
        <div class="grid-column--12 padding--1em s__padding--0">
            <div class="display--flex justify-content--space-between flex-wrap--wrap">
                <div>
                    <img class="icon" data-th-src="@{/static/image/icon-basket.svg}" alt="basket"/>
                    <span class="font-weight--bold" data-th-text="#{fintics.BasketAsset}"></span>
                    <span class="font-size--smaller font-weight--bold">
                        (
                        <span data-th-text="#{fintics.Trade.investAmount}"></span>:
                        <span data-th-text="${#numbers.formatDecimal(trade.investAmount,3,'COMMA',2,'POINT')}"></span>
                        )
                    </span>
                </div>
                <div>
                    <img class="icon" data-th-src="@{/static/image/icon-balance.svg}" alt="balance"/>
                    <span class="font-size--smaller">
                        <span class="font-weight--bold">
                            <span data-th-text="#{fintics.Balance.totalAmount}"></span>:
                            <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                                  th:data-duice-property="totalAmount" data-duice-format="number">
                            </span>
                        </span>
                        |
                        <span data-th-text="#{fintics.Balance.profitAmount}"></span>:
                        <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                              th:data-duice-property="profitAmount" data-duice-format="number">
                        </span>
                        |
                        <span data-th-text="#{fintics.Balance.realizedProfitAmount}"></span>:
                        <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                              th:data-duice-property="realizedProfitAmount" data-duice-format="number">
                        </span>
                        |
                        <span data-th-text="#{fintics.Balance.purchaseAmount}"></span>:
                        <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                              th:data-duice-property="purchaseAmount" data-duice-format="number">
                        </span>
                        |
                        <span data-th-text="#{fintics.Balance.valuationAmount}"></span>:
                        <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                              th:data-duice-property="valuationAmount" data-duice-format="number">
                        </span>
                        |
                        <span data-th-text="#{fintics.Balance.cashAmount}"></span>:
                        <span th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').balance|"
                              th:data-duice-property="cashAmount" data-duice-format="number">
                        </span>
                    </span>
                </div>
            </div>
            <div class="overflow-x--scroll border-top--1" style="max-height:700px;">
                <table class="width--100 font-size--smaller">
                    <colgroup>
                        <col style="width:4em;"/>
                        <col style="width:8em;"/>
                        <col style="width:40em;"/>
                        <col style="width:10em;"/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="text-align--center">
                            <span data-th-text="#{web.global.no}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.TradeAsset.assetId}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.TradeAsset.assetName}"></span>
                        </th>
                        <th class="text-align--center">
                            <span data-th-text="#{fintics.Asset.links}"></span>
                        </th>
                        <th class="text-align--center">
                            <span>Message</span>
                        </th>
                        <th class="text-align--right">
                            <div data-th-text="#{fintics.BalanceAsset.quantity}"></div>
                            <div data-th-text="#{fintics.BalanceAsset.orderableQuantity}"></div>
                        </th>
                        <th class="text-align--right">
                            <div data-th-text="#{fintics.BalanceAsset.purchasePrice}"></div>
                            <div data-th-text="#{fintics.BalanceAsset.valuationPrice}"></div>
                        </th>
                        <th class="text-align--right">
                            <div data-th-text="#{fintics.BalanceAsset.purchaseAmount}"></div>
                            <div data-th-text="#{fintics.BalanceAsset.valuationAmount}"></div>
                        </th>
                        <th class="text-align--right padding-right--1em">
                            <div data-th-text="#{fintics.BalanceAsset.profitAmount}"></div>
                            <div data-th-text="#{fintics.BalanceAsset.profitPercentage}"></div>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').basket.basketAssets|" data-duice-loop="basketAsset,status">
                        <td class="text-align--center">
                            <span data-duice-bind="status" data-duice-property="count"></span>
                        </td>
                        <td>
                            <span data-duice-bind="basketAsset" data-duice-property="assetId"></span>
                        </td>
                        <td>
                            <img class="icon icon--circle font-size--large" data-duice-bind="basketAsset" data-duice-property="icon" th:onerror="|this.onerror=null; this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                            &nbsp;
                            <span data-duice-bind="basketAsset"
                                  data-duice-property="assetName"
                                  data-duice-execute="
                                    if (basketAsset.quantity > 0) {
                                        this.classList.add('font-weight--bold');
                                    }"></span>
                            <small>(<span data-duice-bind="basketAsset" data-duice-property="holdingWeight"></span>%)</small>
                            <small style="opacity:0.5;">|</small>
                            <span class="font-weight--bold"
                                  data-duice-bind="basketAsset"
                                  data-duice-execute="
                                    let close = basketAsset.close;
                                    let netChange = basketAsset.netChange || 0;
                                    let netChangePercentage = basketAsset.netChangePercentage || 0;
                                    if (netChange > 0) this.classList.add('color--red');
                                    if (netChange < 0) this.classList.add('color--blue');
                                    this.innerHTML = `${close?.toLocaleString()||''} (${netChange} <small>/</small> ${netChangePercentage}%)`;
                                    "></span>
                        </td>
                        <td class="text-align--center">
                            <select data-duice-bind="basketAsset"
                                    data-duice-option="basketAsset.links"
                                    data-duice-option-value-property="url"
                                    data-duice-option-text-property="name"
                                    onchange="_openLink(this.value, '_blank'); this.value = '';">
                                <option value>- Link -</option>
                            </select>
                        </td>
                        <td>
                            <div class="display--flex padding--1px">
                                <textarea data-duice-bind="basketAsset"
                                          data-duice-property="message"
                                          class="font-size--smaller font-weight--bold width--100"
                                          style="min-width:20em; height:6em; line-height:1.1em; padding:0.1em 0.3em;"></textarea>
                            </div>
                        </td>
                        <td class="text-align--right">
                            <div data-duice-bind="basketAsset" data-duice-property="quantity" data-duice-format="number"></div>
                            <div data-duice-bind="basketAsset" data-duice-property="orderableQuantity" data-duice-format="number"></div>
                        </td>
                        <td class="text-align--right">
                            <div data-duice-bind="basketAsset" data-duice-property="purchasePrice" data-duice-format="number"></div>
                            <div data-duice-bind="basketAsset" data-duice-property="valuationPrice" data-duice-format="number"></div>
                        </td>
                        <td class="text-align--right">
                            <div data-duice-bind="basketAsset" data-duice-property="purchaseAmount" data-duice-format="number"></div>
                            <div data-duice-bind="basketAsset" data-duice-property="valuationAmount" data-duice-format="number"></div>
                        </td>
                        <td class="text-align--right padding-right--1em font-weight--bold">
                            <div data-duice-bind="basketAsset" data-duice-property="profitAmount" data-duice-format="number"
                                 data-duice-execute="
                                if(basketAsset.profitAmount > 0) this.classList.add('color--red');
                                if(basketAsset.profitAmount < 0) this.classList.add('color--blue');
                                "></div>
                            <div data-duice-bind="basketAsset" data-duice-execute="
                                if (basketAsset.profitPercentage == null) return;
                                if (basketAsset.profitPercentage > 0) this.classList.add('color--red');
                                if (basketAsset.profitPercentage < 0) this.classList.add('color--blue');
                                this.innerHTML = `${basketAsset.profitPercentage} %`;
                                "></div>
                        </td>
                    </tr>
                    <tr th:data-duice-bind="|trades.find(it => it.tradeId === '${trade.tradeId}').basket.basketAssets|"
                        th:data-duice-if="|return trades.find(it => it.tradeId === '${trade.tradeId}').basket.basketAssets.length < 1|"
                        hidden>
                        <td colspan="100%" class="text-align--center">
                            <span data-th-text="#{web.global.itemNotFound(#{fintics.BasketAsset})}"></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- ================================== -->
    <!-- end: trade                         -->
    <!-- ================================== -->

</th:block>
